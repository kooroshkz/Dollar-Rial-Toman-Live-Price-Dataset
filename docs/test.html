<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Dollar Dataset</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chart { width: 100%; height: 400px; border: 1px solid #ccc; margin: 20px 0; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat { padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .error { color: red; padding: 10px; background: #ffebee; border-radius: 5px; }
        .success { color: green; padding: 10px; background: #e8f5e8; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üìä Test Page</h1>
    <div id="status">Initializing...</div>
    
    <div class="stats">
        <div class="stat">
            <strong>Total Records:</strong> <span id="totalRecords">-</span>
        </div>
        <div class="stat">
            <strong>Last Update:</strong> <span id="lastUpdate">-</span>
        </div>
        <div class="stat">
            <strong>Current Price:</strong> <span id="currentPrice">-</span>
        </div>
    </div>
    
    <div id="chart"></div>
    
    <div>
        <h3>Recent Data:</h3>
        <div id="recentData">Loading...</div>
    </div>

    <script>
        // Test data
        const SAMPLE_DATA = [
            { date: '31/07/2025', persianDate: '1404/05/09', time: '2025-07-31', open: 89000, high: 90885, low: 89570, close: 90560 },
            { date: '30/07/2025', persianDate: '1404/05/08', time: '2025-07-30', open: 88500, high: 89200, low: 88100, close: 89000 },
            { date: '29/07/2025', persianDate: '1404/05/07', time: '2025-07-29', open: 87800, high: 88600, low: 87500, close: 88500 },
            { date: '28/07/2025', persianDate: '1404/05/06', time: '2025-07-28', open: 87200, high: 87900, low: 87000, close: 87800 },
            { date: '27/07/2025', persianDate: '1404/05/05', time: '2025-07-27', open: 86800, high: 87300, low: 86500, close: 87200 }
        ];

        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'error' : 'success';
            console.log('Status:', message);
        }

        async function initTest() {
            try {
                updateStatus('Step 1: Checking TradingView library...');
                
                if (typeof LightweightCharts === 'undefined') {
                    throw new Error('TradingView library not loaded');
                }
                
                updateStatus('Step 2: Creating chart...');
                const chartContainer = document.getElementById('chart');
                const chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 400,
                    layout: {
                        background: { type: 'solid', color: '#ffffff' },
                        textColor: '#333',
                    }
                });

                updateStatus('Step 3: Adding candlestick series...');
                const candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                });

                updateStatus('Step 4: Preparing data...');
                const chartData = SAMPLE_DATA.map(item => ({
                    time: item.time,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                }));

                console.log('Chart data:', chartData);

                updateStatus('Step 5: Setting data to chart...');
                candlestickSeries.setData(chartData);
                chart.timeScale().fitContent();

                updateStatus('Step 6: Updating statistics...');
                document.getElementById('totalRecords').textContent = SAMPLE_DATA.length.toLocaleString();
                document.getElementById('lastUpdate').textContent = SAMPLE_DATA[SAMPLE_DATA.length - 1].date;
                document.getElementById('currentPrice').textContent = SAMPLE_DATA[SAMPLE_DATA.length - 1].close.toLocaleString();

                updateStatus('Step 7: Updating recent data table...');
                const recentDataDiv = document.getElementById('recentData');
                recentDataDiv.innerHTML = SAMPLE_DATA.map(record => 
                    `<div>${record.date} - ${record.persianDate} - Close: ${record.close.toLocaleString()}</div>`
                ).join('');

                updateStatus('‚úÖ All steps completed successfully!');

            } catch (error) {
                console.error('Error in test:', error);
                updateStatus(`‚ùå Error: ${error.message}`, true);
            }
        }

        // Wait for DOM and run test
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTest);
        } else {
            initTest();
        }
    </script>
</body>
</html>
